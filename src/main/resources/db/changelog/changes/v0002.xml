<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="v0002" author="danielrampanelli">

        <createTable tableName="pagebuilder_page_version"
            remarks="Stores all versions for a single page.">
            <column name="id" type="uuid">
                <constraints nullable="false" unique="true" primaryKey="true"
                    primaryKeyName="pk_5d512f801dc78" />
            </column>
            <column name="page_id" type="uuid">
                <constraints nullable="false"
                    foreignKeyName="fk_5d43be172a6ad_page_id"
                    referencedTableName="pagebuilder_page" referencedColumnNames="id"
                    deleteCascade="true" />
            </column>
            <column name="hash" type="varchar(40)">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="uk_5d512f9a843be_hash" />
            </column>
            <column name="updated_datetime" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="text">
                <constraints nullable="true" />
            </column>
            <column name="comment" type="text">
                <constraints nullable="true" />
            </column>
        </createTable>

        <createTable tableName="pagebuilder_page_publication"
            remarks="Stores data about published page versions.">
            <column name="id" type="uuid">
                <constraints nullable="false" unique="true" primaryKey="true"
                    primaryKeyName="pk_5d5175437f5f2" />
            </column>
            <column name="domain_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="subdomain_name" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="path_name" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="status" type="varchar(16)">
                <constraints nullable="false" />
            </column>
            <column name="deployed_datetime" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="version_id" type="uuid">
                <constraints nullable="false"
                    foreignKeyName="fk_5d5177e610ddf_version_id"
                    referencedTableName="pagebuilder_page_version" referencedColumnNames="id" />
            </column>
        </createTable>

        <addUniqueConstraint constraintName="uk_5d517824b0ae4_uri"
            tableName="pagebuilder_page_publication" columnNames="domain_name, path_name" />

        <dropUniqueConstraint tableName="pagebuilder_page"
            constraintName="uk_5d445ece1821b_hash" />

        <dropUniqueConstraint tableName="pagebuilder_page"
            constraintName="uk_5d43bdeb05976_uri" />

        <dropColumn tableName="pagebuilder_page" columnName="domain_name" />

        <dropColumn tableName="pagebuilder_page" columnName="path_name" />

        <dropColumn tableName="pagebuilder_page" columnName="hash" />

        <dropColumn tableName="pagebuilder_page" columnName="title" />

        <dropColumn tableName="pagebuilder_page" columnName="description" />

        <addColumn tableName="pagebuilder_page">
            <column name="draft_version_id" type="uuid">
                <constraints nullable="true"
                    foreignKeyName="fk_5d5131f877b52_draft_version_id"
                    referencedTableName="pagebuilder_page_version" referencedColumnNames="id" />
            </column>
            <column name="public_version_id" type="uuid">
                <constraints nullable="true"
                    foreignKeyName="fk_5d51320b413d9_public_version_id"
                    referencedTableName="pagebuilder_page_version" referencedColumnNames="id" />
            </column>
            <column name="publication_id" type="uuid">
                <constraints nullable="true"
                    foreignKeyName="fk_5d527f8c6b379_publication_id"
                    referencedTableName="pagebuilder_page_publication"
                    referencedColumnNames="id" deleteCascade="true" />
            </column>
        </addColumn>

        <dropForeignKeyConstraint
            baseTableName="pagebuilder_page_content" constraintName="fk_5d43be892a8ad_page_id" />

        <dropColumn tableName="pagebuilder_page_content" columnName="page_id" />

        <addColumn tableName="pagebuilder_page_content">
            <column name="page_version_id" type="uuid" afterColumn="id">
                <constraints nullable="false"
                    foreignKeyName="fk_5d513199bac61_page_version_id"
                    referencedTableName="pagebuilder_page_version" referencedColumnNames="id"
                    deleteCascade="true" />
            </column>
        </addColumn>

    </changeSet>

</databaseChangeLog>